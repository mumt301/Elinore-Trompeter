<!DOCTYPE html>
<html>
    <head>
        <a href="index.html">Home</a>
        <title>Assignment 6</title>
        <h1>Assignment 6</h1>
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <style>
            *{text-align: center;}
            body {
                background-color:rgb(244, 164, 96, 0.5);
            }
            h1 {
                font-family: Georgia, 'Times New Roman', Times, serif;
                color: rgb(240, 17, 17);
                font-size: 50px;
                font-weight: 80;
            }
        </style>
    </head>
    <body>            
        <div>
            <h2>MusicBrainz API Call</h2>
            <p>Retrieve an artist's discography by entering their name below!</p>
            <form id="artist" method="GET">
                <label for="name">Artist name</label>
                <input type="text" name="artist" id="name">
                <input type="submit" value="Get info">
            </form>
            <p id="placeholder"></p>
        </div>
        <script type="text/JavaScript">
            function queryArtist() {

                let params = (new URL(document.location)).searchParams;
                if (params.has('artist')) {
                    let artistName = params.get('artist');
                    console.log(artistName);
                    let mbBaseURL = "https://musicbrainz.org/ws/2/";
                    let mbResource = "artist?query=";
                    let queryURL = mbBaseURL + mbResource + artistName;
                    console.log(queryURL);
                    httpGet(queryURL, getMBID);
                }
            function queryAlbums(ambid) {
                    let mbBaseURL = "https://musicbrainz.org/ws/2/";
                    let mbBrowse = "release-group?artist=";
                    let limit = "&limit=200";
                    let Browse = mbBaseURL + mbBrowse + ambid + limit;
                    httpGet(Browse, getAlbum);
                }
            function httpGet(theURL, cbFunction) {
                    let xmlHttp = new XMLHttpRequest();
                    xmlHttp.open("GET", theURL);
                    xmlHttp.send();
                    xmlHttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            cbFunction(this); 
                        }
            function getMBID(xhttp) {
                    let retrievedData = xhttp.responseXML;
                    console.log(retrievedData);
                    let artistData = retrievedData.getElementsByTagName("artist")[0];
                    console.log(artistData);
                    let artistName = artistData.getElementsByTagName('name')[0].innerHTML;
                    let mBaseURL = "https://musicbrainz.org/ws/2/release-group?artist=";
                    let queryURL = mBaseURL + artistMBID;
                    console.log(queryURL);
                    httpGet(queryURL, getAlbums)
            }
            
            function httpGet(theURL, cbFunction) {
                // Step 4: Make the HTTP request call to MusicBrainz
                
                // Creates a new XMLHttpRequest object
                let xmlHttp = new XMLHttpRequest();
                
                // Specify the request method and URL of the request, and send the request to the server
                xmlHttp.open("GET", theURL);
                xmlHttp.send();
                
                // Wait for the response to be ready and store it in a variable
                xmlHttp.onreadystatechange = function () {
                    // Define a function to be called when the readyState property changes
                    if (this.readyState == 4 && this.status == 200) {
                        // when readyState is 4 and status is 200, the response is ready
                        cbFunction(this); // Then, we call the callback function to parse the response and render the appropriate results
                    }
                };
            }

            /* Callback Function
            https://www.w3schools.com/xml/ajax_xmlhttprequest_response.asp
            A "callback function" is a function passed as a parameters to another function.
            If you have more than one AJAX task in a website, 
            you should create one function for executing the XMLHttpRequest object, 
            and one callback function for each AJAX task.
            The function call should contain the URL and what function to call when the response is ready.
            */
            function getMBID(xhttp) {
                let retrievedData = xhttp.responseXML; // Returns the response as XML data
                console.log(retrievedData);

                // Step 5: Parse the response from the server
                let artistData = retrievedData.getElementsByTagName("artist")[0];
                console.log(artistData);
                let artistName = artistData.getElementsByTagName('name')[0].innerHTML; // => Construct this in parts: ('name'), [0], innerHTML
                console.log(artistName);
                let artistMBID = artistData.id;
                console.log(artistMBID);
                let artistCountry = artistData.getElementsByTagName("country")[0].innerHTML; // => Construct this in parts: ('country'), [0], innerHTML
                console.log(artistCountry);

                // Step 6: Render the data in the browser as bullet points
                let placeholder = document.getElementById('placeholder');
                placeholder.innerHTML = `The data for <b>${artistName}</b> is:
                <ul>
                    <li><b>MusicBrainz ID</b> is <i>${artistMBID}</i></li>
                    <li><b>Country</b> is <i>${artistCountry}</i></li>
                </ul>
                `
                //console.log(document);
            }

            // Call to the main function at loading
            window.onload = queryArtist;
        </script>
    </body>
</html>